using Polynomials, QuadGK
import SpecialFunctions: loggamma

const u_polys = ImmutablePolynomial.([
    [1.0], # t^0
    [1. / 8., 0., -5. / 24], # t^1 * (1/8 + 0t^1 - 5/24t^2)
    [9. / 128., 0., -77. / 192., 0., 385. / 1152], # t^2
    [75. / 1024., 0., -4563. / 5120., 0., 17017. / 9216., 0., -85085. / 82944], # t^3
    [
        3675. / 32768., 0.,
        -96833. / 40960., 0.,
        144001. / 16384., 0,
        -7436429. / 663552., 0.,
        37182145. / 7962624
    ], # t^4
    [
        59535. / 262144., 0.,
        -67608983. / 9175040., 0.,
        250881631. / 5898240., 0.,
        -108313205. / 1179648., 0.,
        5391411025. / 63700992., 0.,
        -5391411025. / 191102976
    ], # t^5
    [
        2401245. / 4194304., 0.,
        -388895895. / 14680064., 0.,
        1441372804469. / 6606028800., 0.,
        -33010308331. / 47185920., 0.,
        4445922195. / 4194304., 0.,
        -1169936192425. / 1528823808., 0.,
        5849680962125. / 27518828544
    ], # t^6
    [
        57972915. / 33554432., 0.,
        -25388505925. / 234881024., 0.,
        1007390378503. / 838860800., 0.,
        -1602251736839. / 301989888., 0.,
        10559432785187. / 905969664., 0.,
        -36927006432745. / 2717908992., 0.,
        1774793203908725. / 220150628352., 0.,
        -1267709431363375. / 660451885056
    ], # t^7
    [
        13043905875. / 2147483648., 0.,
        -928090660435. / 1879048192., 0.,
        667955999804539. / 93952409600., 0.,
        -276439228010667. / 6710886400., 0.,
        3542717254441859. / 28991029248., 0.,
        -39803268297948155. / 195689447424., 0.,
        75358832548684685. / 391378894848., 0.,
        -512408152157076175. / 5283615080448., 0.,
        2562040760785380875. / 126806761930752.
    ], # t^8
    [
        418854310875. / 17179869184., 0,
        -472414367256615. / 188978561024., 0,
        1359491937582325. / 30064771072., 0.,
        -3739063570455884033. / 11274289152000., 0.,
        817138105244771959. / 644245094400., 0.,
        -17618708259302571707. / 6262062317568., 0.,
        35348759075759093965. / 9393093476352., 0,
        -3128960418491082175. / 1043677052928., 0,
        1330723971151926826475. / 1014454095446016., 0,
        -6653619855759634132375.0/27390260577042432.0
    ], # t^9
    [
        30241281245175.0/274877906944.0, 0,
        -20993386079260455.0/1511828488192.0, 0,
        45660648644355162105.0/148159191842816.0, 0,
        -35892416277828185849.0/12884901888000.0, 0,
        1232816120293110459821.0/92771293593600.0, 0,
        -5227733363217471800551.0/139156940390400.0, 0,
        19941766574064397067317.0/300578991243264.0, 0,
        -16705838021516291703055.0/225434243432448.0, 0,
        91891691150784941691275.0/1803473947459584.0, 0,
        -4318199286388002551911375.0/219122084616339456.0, 0,
        4318199286388002551911375.0/1314732507698036736.0
    ], # t^10
    [
        1212400457192925.0/2199023255552.0, 0,
        -26416375998266454375.0/314460325543936.0, 0,
        241770821762631191867.0/107752139522048.0, 0,
        -329641577686894230674187.0/13469017440256000.0, 0,
        527174389121818780771231.0/3710851743744000.0, 0,
        -23186185730591085896097833.0/46756731971174400.0, 0,
        164293183874328160710877.0/148434069749760.0, 0,
        -11694306169843138084657687.0/7213895789838336.0, 0,
        201734750392525792544487385.0/129850124217090048.0, 0,
        -365967912305800454531456575.0/389550372651270144.0, 0,
        3424332034105686023665720375.0/10517860061584293888.0, 0,
        -1556514560957130010757145625.0/31553580184752881664.0
    ], # t^11
    [
        213786613951685775.0/70368744177664.0, 0,
        -1383228778609739182725.0/2515682604351488.0, 0,
        4288535808487871046652577.0/246536895226445824.0, 0,
        -1247431715337149394208117.0/5541538603991040.0, 0,
        1440134927609056360249131941.0/923589767331840000.0, 0,
        -12275126748382902959849354203.0/1870269278846976000.0, 0,
        40295057240679430076066704447.0/2244323134616371200.0, 0,
        -1058890883945614567899138703.0/32061759065948160.0, 0,
        171527591207538652048777279465.0/4155203974946881536.0, 0,
        -323782209780772997264458503055.0/9349208943630483456.0, 0,
        38826657063629086145255937175.0/2077601987473440768.0, 0,
        -1480867953294613492234348347625.0/252428641478023053312.0, 0,
        7404339766473067461171741738125.0/9087431093208829919232.0
    ], # t^12
    [
        10278202593831046875.0/562949953421312.0, 0,
        -311689729229640242227335.0/80501843339247616.0, 0,
        25668144329807404111206969.0/179299560164687872.0, 0,
        -17485727773335283402112401979.0/8068480207410954240.0, 0,
        1172682485145099862891889874709.0/66498463247892480000.0, 0,
        -18549286571206971359638512589.0/211106232532992000.0, 0,
        3692240508888356366982787102811.0/12824703626379264000.0, 0,
        -14897903722108127256835851172369.0/23084466527482675200.0, 0,
        18618233657875371822100705069009.0/18467573221986140160.0,  0,
        -328606042646275236446664121476415.0/299174686196175470592.0, 0,
        367634232582365988089137540027775.0/448762029294263205888.0, 0,
        -179099209477310436044105950399825.0/448762029294263205888.0, 0,
        8323958765469022439849272062000125.0/72699448745670639353856.0, 0,
        -3201522602103470169172796946923125.0/218098346237011918061568.0
    ]
])

u(k::Real, t::Real) = t^k * u_polys[k](t)

function mu(v::Real, x::Real, K::Integer)
    mu = 4 * v^2
    total = 1.0
    current_term = 1.0
    for k in 1:(K+1)
        current_term *= (mu - (2*k - 1)^2) / (k * 8 * x)
        total += current_term
    end
    log_total = log(abs(total))
    (log(pi) - log(2x)) / 2 - x + log_total
end

"""Compute log(K_v(x)) using U_K asymptotic expansion, eq. 19 from paper.

Parameters:
v (float): Order of the Bessel function.
x (float): Argument of the Bessel function.
K (int): Number of terms in the expansion (4, 6, 9, or 13).

Returns:
float: log(K_v(x)) computed via asymptotic expansion.
"""
function U(v::Real, x::Real, K::Integer)
    # Avoid division by zero for v=0
    (v == 0) && return logK_int(v, x)

    xp = x / v
    t = 1 / sqrt(1 + xp^2)
    sqrt_term = sqrt(1 + xp^2)
    eta = sqrt_term + log(xp / (1 + sqrt_term))

    series_sum = 1 + sum((-1)^k * u(k, t) / v^k for k in 1:(K+1))

    (log(pi) - log(2v)) / 2 - v * eta - 0.25*log(1 + xp^2) + log(abs(series_sum))
end

function logK_int(v::Real, x::Real)
    f(u,v,x,n=8) = let
        b = 2 * n / (2 * v + 1)
        b * exp(-u^b) * (2*x + u^b)^(v-1/2) * u^(n-1) + exp(-1/u) * u^(-2*v-1) * (2*x*u+1)^(v-1/2)
    end
    integral, _ = quadgk(u -> f(u,v,x), 0, 1)
    log(pi)/2 - loggamma(v + 1/2) - v * log(2x) - x + log(integral)
end

"""Logarithm of the modified Bessel function of the second kind: log(K_v(x)).
Uses decision tree from Table 1 of paper.

Parameters:
- v: Order of the Bessel function.
- x: Argument of the Bessel function.

Returns: log(K_v(x))

Reference: https://arxiv.org/abs/2409.08729v1
"""
function lbesselk(v::Real, x::Real)
    v = abs(v) # K_v(x) is symmetric in order `v`.
    (isnan(v) || isnan(x)) && return NaN

    # "Ordered top-to-bottom from fastest to slowest", see description of Table 1.
    if (x > 1400 && v < 3.05) || ( (0.6229 * log(x) - 3.2318 > log(v)) && (v > 3.1) )
        mu(v, x, 3)
    elseif (x > 30 && v < 15.3919) || ( (0.5113 * log(x) + 0.7939 > log(v)) && (x > 59.6925) )
        mu(v, x, 20)
    elseif (x > 274.2377 && v > 0.3) || (v > 163.6993)
        U(v, x, 4)
    elseif (x > 84.4153 && v > 0.46) || (v > 56.9971)
        U(v, x, 6)
    elseif (x > 35.9074 && v > 0.6) || (v > 20.1534)
        U(v, x, 9)
    elseif (x > 19.6931 && v > 0.7) || (v > 12.6964)
        U(v, x, 13)
    else
        logK_int(v, x)
    end
end

function lbesselk_basic(v::Real, x::Real, K::Integer=10)
    (isnan(v) || isnan(x)) && return NaN
    # FIXME: lbesselk(NaN, NaN) produces SegmentationFault within SpecialFunctions
    if x > 600
        # Asymptotic expansion, works for massive values of `x` on the order of 10^3, 10^4 and higher.
        # Important, because otherwise PDF becomes exactly zero `exp(-Inf)==0` way too early.
        μ = 4v^2
        term = one(x)
        s = one(x)
        for k in 1:K
            term *= (μ - (2k-1)^2) / (k * 8x)
            s += term
        end
        (log(π) - log(2x))/2 - x + log(abs(s))
    else
        log(besselk(v, x)) # Returns `-Inf` for x>600
    end
end

const lbesselk_int_zinv_polys = Polynomial.([
    [1.0], # k=0
    [1., 1.], # k=1
    [1.,3.,3.],
    [1.,6.,15.,15.],
    [1.,10,45,105,105],
    [1.,15,105,420,945,945],
    [1.,21,210,1260,4725,10395,10395],
    [1.,28,378,3150,17325,62370,135135,135135],
    [1.,36,630,6930,51975,270270,945945,2027025,2027025],
    [1.,45,990,13860,135135,945945,4729725,16216200,34459425,34459425],
    [1.,55,1485,25740,315315,2837835,18918900,91891800,310134825,654729075,654729075], # k=10
])

"""
    lbesselk_int_zinv(k::Integer, z::Real)

Computes `Log@BesselK[k + 1/2, 1/z]` for `k ∈ {0, 1, ..., 10}`.
"""
lbesselk_int_zinv(k::Integer, z::Real) = log(π/2)/2 - 1/z + log(z)/2 + log(lbesselk_int_zinv_polys[k+1](z))

"""
    lbesselk_int(k::Integer, z::Real)

Computes `Log@BesselK[k + 1/2, z]` for `k ∈ {-1, 0, 1, ..., 10}`.
Note that `Log@BesselK[-1 + 1/2, z] == Log@BesselK[0 + 1/2, z]`.
"""
lbesselk_int(k::Integer, x::Real) = lbesselk_int_zinv(ifelse(k == -1, 0, k), 1/x)